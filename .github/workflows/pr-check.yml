name: PR Check

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  lint-and-test:
    name: Lint and Test
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Install uv
      uses: astral-sh/setup-uv@v5
      with:
        version: "latest"

    - name: Set up Python
      run: uv python install 3.12

    - name: Install dependencies
      run: uv sync

    - name: Run linting
      id: lint
      run: |
        echo "::group::Ruff Check"
        uv run ruff check backend tests
        echo "::endgroup::"

    - name: Run formatting check
      id: format
      run: |
        echo "::group::Ruff Format Check"
        uv run ruff format --check backend tests
        echo "::endgroup::"

    - name: Run tests with coverage
      id: test
      run: |
        echo "::group::Pytest"
        uv run pytest -v --tb=short
        echo "::endgroup::"
      env:
        ANTHROPIC_API_KEY: test-dummy-key-for-ci

    - name: Comment PR with results
      if: always()
      uses: actions/github-script@v7
      with:
        script: |
          const lint = '${{ steps.lint.outcome }}' === 'success' ? '‚úÖ' : '‚ùå';
          const fmt = '${{ steps.format.outcome }}' === 'success' ? '‚úÖ' : '‚ùå';
          const test = '${{ steps.test.outcome }}' === 'success' ? '‚úÖ' : '‚ùå';
          const output = `#### Test Results üß™

          - ${lint} Linting
          - ${fmt} Formatting check
          - ${test} Tests

          *Pushed by: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;
