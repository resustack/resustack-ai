name: PR Check

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  lint-and-test:
    name: Lint and Test
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install uv
      uses: astral-sh/setup-uv@v5
      with:
        version: "latest"

    - name: Set up Python
      run: uv python install 3.12

    - name: Install dependencies
      run: uv sync

    - name: Run linting
      run: |
        echo "::group::Ruff Check"
        uv run ruff check backend tests
        echo "::endgroup::"

    - name: Run formatting check
      run: |
        echo "::group::Ruff Format Check"
        uv run ruff format --check backend tests
        echo "::endgroup::"

    - name: Run tests with coverage
      run: |
        echo "::group::Pytest"
        uv run pytest -v --tb=short
        echo "::endgroup::"

    - name: Comment PR with results
      if: always()
      uses: actions/github-script@v7
      with:
        script: |
          const output = `#### Test Results ðŸ§ª

          - âœ… Linting passed
          - âœ… Formatting check passed
          - âœ… Tests passed

          *Pushed by: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: output
          })
